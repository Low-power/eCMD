# Makefile for the ecmd cmdline

# Base info and default build rules
SUBDIR     := cmd/
include ../makefile.rules

VPATH        := ../capi
INCLUDES     := ecmdClientCapi.H  ecmdDataBuffer.H  ecmdDataBufferBase.H ecmdReturnCodes.H ecmdStructs.H ecmdUtils.H ecmdSharedUtils.H
INT_INCLUDES := ecmdInterpreter.H ecmdExtInterpreter.H ecmdCommandUtils.H
SOURCE       := ecmdMain.C ecmdExtInterpreter.C ecmdInterpreter.C ecmdScomUser.C ecmdCommandUtils.C ecmdRingUser.C ecmdQueryUser.C ecmdSpyUser.C ecmdSimUser.C ecmdArrayUser.C ecmdJtagUser.C ecmdProcUser.C ecmdMemUser.C ecmdIstepUser.C ecmdMiscUser.C ecmdVpdUser.C ecmdI2cGpioUser.C ecmdPowerUser.C ecmdPsiUser.C
CFLAGS       := ${CFLAGS} -I../capi -I../dll 

VER_SOURCE   := ecmdVersion.C

# This is the source generated by makeext.py
GENERATED_SOURCE := ecmdExtInterpreter.C

# Don't want to include the cmd extension
EXTENSIONS   := $(subst cmd,,${EXTENSIONS})
# Don't want to include the scand extension, there isn't one
EXTENSIONS   := $(subst scand,,${EXTENSIONS})
# Don't want to include the fapi extension, there isn't one
EXTENSIONS   := $(subst fapi2,,${EXTENSIONS})
EXTENSIONS   := $(subst fapi,,${EXTENSIONS})

VPATH        := ${VPATH}$(foreach ext, ${EXTENSIONS},:${OBJROOT}/ext/${ext}/cmd/${OBJDIR}:${OBJROOT}/ext/${ext}/capi/${OBJDIR}:../ext/${ext}/cmd/:../ext/${ext}/capi/)
VPATH := $(subst ${space},,${VPATH})

INCLUDES     := ${INCLUDES} $(foreach ext, ${EXTENSIONS}, ${ext}Interpreter.H ${ext}ClientCapi.H ${ext}Structs.H)
CFLAGS       := ${CFLAGS} $(foreach ext, ${EXTENSIONS},-I../ext/${ext}/cmd -I../ext/${ext}/capi -DECMD_$(shell echo ${ext} | tr "a-zA-Z" "A-Za-z")_EXTENSION_SUPPORT)

# *****************************************************************************
# The Common Setup stuff
# *****************************************************************************
TARGET     := ecmd
VER_TARGET := ecmdVersion
LINK_OBJS  := ${LINK_OBJS} ${OBJROOT}/capi/${OBJDIR}/ecmdClientCapi.a
LINK_OBJS  := ${LINK_OBJS} $(foreach ext, ${EXTENSIONS}, ${ext}ClientCapi.a ${OBJROOT}/ext/${ext}/cmd/${OBJDIR}/${ext}CmdInterpreter.a)

# *****************************************************************************
# The x86 Linux Setup stuff
# *****************************************************************************
ifeq (${TARGET_OS},x86)
  ifeq (${TARGET_ARCH},x86)
    LDLIBS    := ${LDLIBS} -ldl -L${OBJROOT}/capi/${OBJDIR} -lecmd
  else
    LDLIBS    := ${LDLIBS} -ldl -L${OBJROOT}/capi/${OBJDIR} -lecmd -lz
  endif
endif

# *****************************************************************************
# The ppc Linux Setup stuff
# *****************************************************************************
ifeq (${TARGET_OS},ppc)
  LDLIBS    := ${LDLIBS} -ldl -L${OBJROOT}/capi/${OBJDIR} -lecmd
endif

# *****************************************************************************
# The Aix Setup stuff
# *****************************************************************************
ifeq (${TARGET_OS},aix)
  ifeq (${TARGET_ARCH},aix)
    LDLIBS    := -brtl -w -L${OBJROOT}/capi/${OBJDIR} -lecmd
  else
    ifeq (${TARGET_ARCH},aix64)
      LDLIBS    := -Wl,-brtl -L${OBJROOT}/capi/${OBJDIR} -lecmd -lz
	else
      LDLIBS    := -brtl -w -L${OBJROOT}/capi/${OBJDIR} -lecmd -lz
    endif
  endif
endif

VPATH     := ${VPATH}:${OBJPATH}

# *****************************************************************************
# The Main Targets
# *****************************************************************************
all: dir ${TARGET} ${VER_TARGET}

clean: objclean
	rm -f ${GENERATED_SOURCE}

objclean:
	rm -rf ${OBJPATH}

dir:
	@mkdir -p ${OBJPATH}

install:
	cp ${OBJPATH}/${TARGET} ${INSTALL_PATH}/${TARGET_ARCH}/bin/
	cp ${OBJPATH}/${VER_TARGET} ${INSTALL_PATH}/${TARGET_ARCH}/bin/

# Build the extensions
extensions:
	@echo " "
	@echo "Building Main Client Api ..."
	@cd ../capi;gmake
	@echo " "
	@echo "Building Extension Client Api's ..."
	@cd ../ext/template/capi;$(foreach ext, ${EXTENSIONS}, cd ../../${ext}/capi;gmake; echo " ";)
	@echo " "
	@echo "Building Extension Command Interpreters ..."
	@cd ../ext/template/cmd;$(foreach ext, ${EXTENSIONS}, cd ../../${ext}/cmd;gmake; echo " ";)
	@echo " "
	@echo "Building Main Command Interpreter ..."

# *****************************************************************************
# Object Build Targets
# *****************************************************************************
SOURCE_OBJS  = $(basename $(SOURCE))
SOURCE_OBJS := $(addprefix ${OBJPATH}, $(SOURCE_OBJS))
SOURCE_OBJS := $(addsuffix .o, $(SOURCE_OBJS))
VER_SOURCE_OBJS  = $(basename $(VER_SOURCE))
VER_SOURCE_OBJS := $(addprefix ${OBJPATH}, $(VER_SOURCE_OBJS))
VER_SOURCE_OBJS := $(addsuffix .o, $(VER_SOURCE_OBJS))

# *****************************************************************************
# Compile code for the common C++ objects if their respective
# code has been changed.  Or, compile everything if a header
# file has changed.
# *****************************************************************************
$(SOURCE_OBJS): ${OBJPATH}%.o : %.C ${INCLUDES} ${INT_INCLUDES}
	@echo Compiling $<
	${VERBOSE}${CC} -c ${CFLAGS} $< -o $@ ${DEFINES}
$(VER_SOURCE_OBJS): ${OBJPATH}%.o : %.C ${INCLUDES}
	@echo Compiling $< 
	${VERBOSE}${CC} -c ${CFLAGS} $< -o $@ ${DEFINES}


# *****************************************************************************
# Create the Client 
# *****************************************************************************
${TARGET}: ${SOURCE_OBJS} ${LINK_OBJS}
	@echo Linking $<
	${VERBOSE}${LD} ${LDFLAGS} $^ -o ${OBJPATH}${TARGET} ${LDLIBS}

${VER_TARGET}: ${VER_SOURCE_OBJS}
	@echo Linking $<
ifeq (${TARGET_OS},aix)
ifeq (${TARGET_ARCH},aix64)
	${VERBOSE}${LD} ${LDFLAGS} -Wl,-brtl $^ -o ${OBJPATH}${VER_TARGET} ${LDLIBS}
else
	${VERBOSE}${LD} ${LDFLAGS} -brtl -w $^ -o ${OBJPATH}${VER_TARGET} ${LDLIBS}
endif
else
	${VERBOSE}${LD} ${LDFLAGS} $^ -o ${OBJPATH}${VER_TARGET} ${LDLIBS}
endif

# *****************************************************************************
# Autogenerate some of the extension source
# *****************************************************************************
${GENERATED_SOURCE}:
	@echo "==== Auto Generating $@"
	@${ECMD_ROOT}/mkscripts/makeext.py cmd

# *****************************************************************************
# Debug rule for any makefile testing 
# *****************************************************************************
debug:
	@echo ${ECMD_ROOT}
	@echo ${SUBDIR}
